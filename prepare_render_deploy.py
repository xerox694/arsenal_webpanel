#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
üöÄ ARSENAL V4 - SCRIPT DE PR√âPARATION D√âPLOIEMENT
Pr√©pare tous les fichiers n√©cessaires pour le d√©ploiement sur Render
"""

import os
import json
import subprocess
import shutil
from pathlib import Path

class RenderDeployPrep:
    def __init__(self):
        self.root_dir = Path(__file__).parent
        self.required_files = [
            'main.py',
            'webpanel_advanced.py', 
            'requirements.txt',
            'render.yaml',
            'core/',
            'modules/',
            'commands/',
            'utils/',
            'templates/',
            'static/',
            'data/',
            'logs/'
        ]
        
    def check_files(self):
        """V√©rifie que tous les fichiers n√©cessaires sont pr√©sents"""
        print("üîç V√©rification des fichiers requis...")
        missing_files = []
        
        for file_path in self.required_files:
            full_path = self.root_dir / file_path
            if not full_path.exists():
                missing_files.append(file_path)
                print(f"‚ùå Manquant: {file_path}")
            else:
                print(f"‚úÖ Trouv√©: {file_path}")
        
        if missing_files:
            print(f"\n‚ö†Ô∏è {len(missing_files)} fichier(s) manquant(s) d√©tect√©(s)")
            return False
        
        print("‚úÖ Tous les fichiers requis sont pr√©sents")
        return True
    
    def create_directories(self):
        """Cr√©e les r√©pertoires n√©cessaires"""
        print("\nüìÅ Cr√©ation des r√©pertoires...")
        
        directories = ['data', 'logs', 'static', 'templates']
        for directory in directories:
            dir_path = self.root_dir / directory
            dir_path.mkdir(exist_ok=True)
            print(f"‚úÖ R√©pertoire cr√©√©: {directory}")
            
            # Cr√©er .gitkeep pour les r√©pertoires vides
            gitkeep = dir_path / '.gitkeep'
            if not gitkeep.exists():
                gitkeep.touch()
    
    def update_requirements(self):
        """Met √† jour requirements.txt avec toutes les d√©pendances"""
        print("\nüì¶ Mise √† jour requirements.txt...")
        
        requirements = [
            "discord.py==2.3.2",
            "Flask==2.3.3",
            "Flask-CORS==4.0.0", 
            "Flask-SocketIO==5.3.6",
            "python-socketio[client]==5.8.0",
            "requests==2.31.0",
            "python-dotenv==1.0.0",
            "gunicorn==21.2.0",
            "psutil==5.9.5",
            "aiohttp==3.9.5",
            "Pillow>=10.3.0",
            "beautifulsoup4==4.12.2",
            "asyncio",
            "json5",
            "colorama",
            "python-dateutil"
        ]
        
        req_file = self.root_dir / 'requirements.txt'
        with open(req_file, 'w', encoding='utf-8') as f:
            f.write('\n'.join(requirements))
        
        print("‚úÖ requirements.txt mis √† jour")
    
    def create_env_template(self):
        """Cr√©e un template des variables d'environnement"""
        print("\nüîß Cr√©ation du template .env...")
        
        env_template = """# üîë VARIABLES D'ENVIRONNEMENT ARSENAL V4
# ============================================

# ü§ñ Configuration Discord (OBLIGATOIRE)
DISCORD_TOKEN=your_bot_token_here
DISCORD_CLIENT_ID=your_client_id_here  
DISCORD_CLIENT_SECRET=your_client_secret_here

# ‚öôÔ∏è Configuration Bot
BOT_PREFIX=!
DEBUG=false

# üåê Configuration WebPanel
FLASK_ENV=production
WEB_SECRET_KEY=your_secret_key_here
WEB_AUTH_ENABLED=true

# üöÄ Configuration Render
ARSENAL_MODE=production
MAX_LOG_LINES=1000
AUTO_RESTART=true
PORT=10000

# üìä Monitoring
ENABLE_METRICS=true
LOG_LEVEL=INFO"""

        env_file = self.root_dir / '.env.template'
        with open(env_file, 'w', encoding='utf-8') as f:
            f.write(env_template)
        
        print("‚úÖ Template .env cr√©√©")
    
    def create_gitignore(self):
        """Cr√©e/met √† jour .gitignore"""
        print("\nüìã Configuration .gitignore...")
        
        gitignore_content = """# Fichiers de configuration sensibles
.env
*.db
*.sqlite3
arsenal_v4.db
hunt_royal*.db
suggestions.db

# Logs et cache
logs/*.log
*.log
__pycache__/
*.pyc
*.pyo
*.pyd
.Python
*.so
.cache/

# Donn√©es temporaires
data/temp/
data/cache/
hunt_royal_cache.json

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
Thumbs.db
$RECYCLE.BIN/

# Distribution / packaging
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
*.egg-info/
.installed.cfg
*.egg

# Virtual environments
venv/
env/
ENV/
.venv/

# Test coverage
htmlcov/
.coverage
.pytest_cache/

# Jupyter Notebook
.ipynb_checkpoints

# Spyder
.spyderproject
.spyproject"""

        gitignore_file = self.root_dir / '.gitignore'
        with open(gitignore_file, 'w', encoding='utf-8') as f:
            f.write(gitignore_content)
        
        print("‚úÖ .gitignore configur√©")
    
    def create_procfile(self):
        """Cr√©e Procfile pour Heroku (optionnel)"""
        print("\n‚öôÔ∏è Cr√©ation Procfile...")
        
        procfile_content = "web: python webpanel_advanced.py --start-bot --host=0.0.0.0 --port=$PORT --production"
        
        procfile = self.root_dir / 'Procfile'
        with open(procfile, 'w', encoding='utf-8') as f:
            f.write(procfile_content)
        
        print("‚úÖ Procfile cr√©√©")
    
    def update_webpanel_for_production(self):
        """Met √† jour webpanel_advanced.py pour la production"""
        print("\nüîß Configuration production webpanel...")
        
        webpanel_file = self.root_dir / 'webpanel_advanced.py'
        if not webpanel_file.exists():
            print("‚ùå webpanel_advanced.py introuvable")
            return
        
        # Lire le contenu actuel
        with open(webpanel_file, 'r', encoding='utf-8') as f:
            content = f.read()
        
        # S'assurer que le mode production est support√©
        if '--production' not in content:
            production_code = '''
        # Mode production pour Render/Heroku
        parser.add_argument('--production', action='store_true', 
                          help='Mode production (d√©sactive debug, optimise performances)')'''
            
            if 'argparse' in content and 'add_argument' in content:
                # Ajouter l'argument production
                content = content.replace(
                    'parser.add_argument(\'--port\'',
                    f'{production_code}\n        parser.add_argument(\'--port\''
                )
        
        # Sauvegarder
        with open(webpanel_file, 'w', encoding='utf-8') as f:
            f.write(content)
        
        print("‚úÖ WebPanel configur√© pour la production")
    
    def create_deployment_script(self):
        """Cr√©e un script de d√©ploiement automatique"""
        print("\nüöÄ Cr√©ation script de d√©ploiement...")
        
        deploy_script = '''#!/bin/bash
# üöÄ Script de d√©ploiement Arsenal V4 sur Render

echo "üöÄ Arsenal V4 - D√©ploiement Render"
echo "=================================="

# V√©rification Git
if ! command -v git &> /dev/null; then
    echo "‚ùå Git n'est pas install√©"
    exit 1
fi

# V√©rification des fichiers
echo "üîç V√©rification des fichiers..."
python prepare_render_deploy.py

if [ $? -ne 0 ]; then
    echo "‚ùå V√©rification √©chou√©e"
    exit 1
fi

# Initialisation Git si n√©cessaire
if [ ! -d ".git" ]; then
    echo "üì¶ Initialisation du repository Git..."
    git init
    git branch -M main
fi

# Ajouter tous les fichiers
echo "üìÅ Ajout des fichiers..."
git add .

# Commit
echo "üíæ Commit des changements..."
git commit -m "üöÄ Arsenal V4 - Configuration compl√®te pour Render"

# Configuration remote (√† modifier avec votre URL)
if ! git remote get-url origin &> /dev/null; then
    echo "üîó Configuration remote GitHub..."
    echo "‚ö†Ô∏è  Configurez votre remote GitHub:"
    echo "   git remote add origin https://github.com/USERNAME/REPO.git"
    echo "   git push -u origin main"
else
    echo "üì§ Push vers GitHub..."
    git push origin main
fi

echo ""
echo "‚úÖ Pr√©paration termin√©e !"
echo ""
echo "üåê √âtapes suivantes:"
echo "1. Aller sur render.com"
echo "2. Connecter votre repository GitHub" 
echo "3. Configurer les variables d'environnement"
echo "4. D√©ployer !"
echo ""
echo "üìñ Documentation compl√®te: DEPLOY_RENDER_GUIDE.md"'''

        deploy_file = self.root_dir / 'deploy.sh'
        with open(deploy_file, 'w', encoding='utf-8') as f:
            f.write(deploy_script)
        
        # Rendre ex√©cutable sur Unix
        try:
            os.chmod(deploy_file, 0o755)
        except:
            pass
        
        print("‚úÖ Script deploy.sh cr√©√©")
    
    def run_preparation(self):
        """Lance toute la pr√©paration"""
        print("üöÄ Arsenal V4 - Pr√©paration D√©ploiement Render")
        print("=" * 50)
        
        # √âtapes de pr√©paration
        steps = [
            ("V√©rification fichiers", self.check_files),
            ("Cr√©ation r√©pertoires", self.create_directories),
            ("Mise √† jour requirements", self.update_requirements),
            ("Template environnement", self.create_env_template),
            ("Configuration .gitignore", self.create_gitignore),
            ("Cr√©ation Procfile", self.create_procfile),
            ("Configuration production", self.update_webpanel_for_production),
            ("Script d√©ploiement", self.create_deployment_script)
        ]
        
        success_count = 0
        for step_name, step_func in steps:
            try:
                step_func()
                success_count += 1
            except Exception as e:
                print(f"‚ùå Erreur {step_name}: {e}")
        
        print(f"\nüéâ Pr√©paration termin√©e: {success_count}/{len(steps)} √©tapes r√©ussies")
        
        if success_count == len(steps):
            print("\n‚úÖ Pr√™t pour le d√©ploiement !")
            print("\nüìã Prochaines √©tapes:")
            print("1. Configurer les variables d'environnement dans .env.template")
            print("2. Ex√©cuter: ./deploy.sh (ou git add . && git commit && git push)")
            print("3. Configurer sur render.com")
            print("\nüìñ Guide complet: DEPLOY_RENDER_GUIDE.md")
        else:
            print("\n‚ö†Ô∏è Certaines √©tapes ont √©chou√©, v√©rifiez les erreurs ci-dessus")

if __name__ == "__main__":
    prep = RenderDeployPrep()
    prep.run_preparation()
