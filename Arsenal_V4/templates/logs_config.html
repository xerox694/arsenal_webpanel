#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Arsenal Bot WebPanel - Configuration Logs Ultra-Avanc√©e
Interface web pour configurer les logs comme DraftBot mais en mieux!
Auteur: xero3elite
Version: 1.0.0
"""

from flask import Flask, render_template, request, jsonify, redirect, url_for
import sqlite3
import json
from datetime import datetime

class ArsenalLogsWebPanel:
    """Interface web pour configurer les logs Arsenal Bot"""
    
    def __init__(self, app):
        self.app = app
        self.register_routes()
        
    def register_routes(self):
        """Enregistrer les routes Flask"""
        
        @self.app.route('/logs/config/<int:guild_id>')
        def logs_config_page(guild_id):
            """Page de configuration des logs pour un serveur"""
            return render_template('logs_config.html', guild_id=guild_id)
        
        @self.app.route('/api/logs/config/<int:guild_id>')
        def get_logs_config(guild_id):
            """API pour r√©cup√©rer la configuration des logs"""
            try:
                config = self.get_guild_logs_config(guild_id)
                return jsonify({
                    'success': True,
                    'data': config
                })
            except Exception as e:
                return jsonify({
                    'success': False,
                    'error': str(e)
                }), 500
        
        @self.app.route('/api/logs/config/<int:guild_id>', methods=['POST'])
        def update_logs_config(guild_id):
            """API pour mettre √† jour la configuration des logs"""
            try:
                data = request.get_json()
                self.update_guild_logs_config(guild_id, data)
                return jsonify({
                    'success': True,
                    'message': 'Configuration mise √† jour avec succ√®s'
                })
            except Exception as e:
                return jsonify({
                    'success': False,
                    'error': str(e)
                }), 500
    
    def get_guild_logs_config(self, guild_id):
        """R√©cup√©rer la configuration d'un serveur"""
        conn = sqlite3.connect('arsenal_logs_config.db')
        cursor = conn.cursor()
        
        # Configuration g√©n√©rale
        cursor.execute('SELECT * FROM logs_settings WHERE guild_id = ?', (str(guild_id),))
        settings = cursor.fetchone()
        
        # Configuration des modules
        cursor.execute('SELECT * FROM logs_config WHERE guild_id = ?', (str(guild_id),))
        modules = cursor.fetchall()
        
        conn.close()
        
        return {
            'guild_id': guild_id,
            'settings': settings,
            'modules': modules
        }
    
    def update_guild_logs_config(self, guild_id, data):
        """Mettre √† jour la configuration d'un serveur"""
        conn = sqlite3.connect('arsenal_logs_config.db')
        cursor = conn.cursor()
        
        # Mettre √† jour la configuration g√©n√©rale
        if 'settings' in data:
            settings = data['settings']
            cursor.execute('''
                INSERT OR REPLACE INTO logs_settings 
                (guild_id, default_channel, default_color, ignored_channels)
                VALUES (?, ?, ?, ?)
            ''', (
                str(guild_id),
                settings.get('default_channel'),
                settings.get('default_color', '#cd6e57'),
                json.dumps(settings.get('ignored_channels', []))
            ))
        
        # Mettre √† jour les modules
        if 'modules' in data:
            for module_name, module_config in data['modules'].items():
                cursor.execute('''
                    INSERT OR REPLACE INTO logs_config
                    (guild_id, module_name, channel_id, enabled, color)
                    VALUES (?, ?, ?, ?, ?)
                ''', (
                    str(guild_id),
                    module_name,
                    module_config.get('channel_id'),
                    module_config.get('enabled', True),
                    module_config.get('color')
                ))
        
        conn.commit()
        conn.close()

# Template HTML pour la configuration des logs
LOGS_CONFIG_TEMPLATE = '''
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arsenal Bot - Configuration des Logs</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00fff7;
            --secondary-color: #0088ff;
            --bg-dark: #0a0a0f;
            --card-bg: rgba(255, 255, 255, 0.05);
            --border-color: rgba(0, 255, 247, 0.3);
            --text-primary: #ffffff;
            --text-secondary: #b8c5d1;
            --success-color: #00ff88;
            --warning-color: #ffaa00;
            --error-color: #ff4444;
            --premium-color: #ff73fa;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1a2e 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        .header {
            background: var(--card-bg);
            border-bottom: 2px solid var(--border-color);
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .header p {
            color: var(--text-secondary);
            font-size: 1.2em;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .config-section {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
        }
        
        .section-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .general-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: bold;
            color: var(--text-primary);
        }
        
        .form-control {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-primary);
            font-size: 1em;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 255, 247, 0.2);
        }
        
        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }
        
        .module-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .module-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 5px 15px rgba(0, 255, 247, 0.1);
        }
        
        .module-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .module-name {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .premium-badge {
            background: var(--premium-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: bold;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--success-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .channel-select {
            margin-top: 10px;
        }
        
        .save-button {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .save-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 247, 0.3);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-enabled { background-color: var(--success-color); }
        .status-disabled { background-color: #555; }
        
        .description {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-cog"></i> Configuration des Logs</h1>
        <p>Syst√®me ultra-avanc√© de logs Arsenal Bot - Surpasse DraftBot !</p>
    </div>
    
    <div class="container">
        <!-- Configuration g√©n√©rale -->
        <div class="config-section">
            <h2 class="section-title">
                <i class="fas fa-sliders-h"></i>
                Param√®tres g√©n√©raux
            </h2>
            
            <div class="general-settings">
                <div class="form-group">
                    <label for="default-channel">
                        <i class="fas fa-hashtag"></i> Salon par d√©faut
                    </label>
                    <select id="default-channel" class="form-control">
                        <option value="">Aucun salon par d√©faut</option>
                        <!-- Salons du serveur charg√©s dynamiquement -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="default-color">
                        <i class="fas fa-palette"></i> Couleur par d√©faut
                    </label>
                    <input type="color" id="default-color" class="form-control" value="#cd6e57">
                </div>
            </div>
        </div>
        
        <!-- Configuration des modules -->
        <div class="config-section">
            <h2 class="section-title">
                <i class="fas fa-puzzle-piece"></i>
                Modules de logs
                <span style="font-size: 0.7em; color: var(--text-secondary);">(Plus complet que DraftBot !)</span>
            </h2>
            
            <div class="modules-grid" id="modules-container">
                <!-- Modules charg√©s dynamiquement via JavaScript -->
            </div>
        </div>
        
        <button class="save-button" onclick="saveConfiguration()">
            <i class="fas fa-save"></i> Sauvegarder la configuration
        </button>
    </div>
    
    <script>
        // Configuration des modules (identique au fichier Python)
        const logModules = {
            // === MOD√âRATION & S√âCURIT√â ===
            "moderation": {
                "name": "üõ°Ô∏è Mod√©ration",
                "description": "Sanctions, avertissements, timeouts",
                "color": "#ff4444",
                "premium": false
            },
            "automod": {
                "name": "ü§ñ Auto-Mod√©ration", 
                "description": "Actions automatiques, filtres",
                "color": "#ff8800",
                "premium": false
            },
            "security": {
                "name": "üîí S√©curit√©",
                "description": "Tentatives de piratage, anti-raid",
                "color": "#cc0000",
                "premium": true
            },
            
            // === GESTION SERVEUR ===
            "server_config": {
                "name": "‚öôÔ∏è Configuration",
                "description": "Modifications des param√®tres serveur",
                "color": "#5865f2",
                "premium": false
            },
            "arrivals_departures": {
                "name": "üö™ Arriv√©es & D√©parts",
                "description": "Membres qui rejoignent/quittent",
                "color": "#00ff88",
                "premium": false
            },
            "channels": {
                "name": "üí¨ Salons",
                "description": "Cr√©ation, suppression, modifications salons",
                "color": "#7289da",
                "premium": false
            },
            "roles": {
                "name": "üë• R√¥les",
                "description": "Cr√©ation, suppression, attribution r√¥les",
                "color": "#9b59b6",
                "premium": false
            },
            
            // === CONTENU & CR√âATIF ===
            "emojis": {
                "name": "üòÄ √âmojis",
                "description": "Ajout, suppression √©mojis/stickers",
                "color": "#f39c12",
                "premium": false
            },
            "nicknames": {
                "name": "üìù Pseudos",
                "description": "Changements de pseudos/surnoms",
                "color": "#3498db",
                "premium": false
            },
            "stickers": {
                "name": "üé® Autocollants",
                "description": "Gestion des stickers serveur",
                "color": "#e74c3c",
                "premium": false
            },
            
            // === √âCONOMIE & GAMING ===
            "economy": {
                "name": "üí∞ Transactions",
                "description": "Syst√®me √©conomique, transferts",
                "color": "#f1c40f",
                "premium": false
            },
            "levels": {
                "name": "üìä Niveaux",
                "description": "Gains XP, mont√©es de niveau",
                "color": "#9b59b6",
                "premium": false
            },
            "gaming": {
                "name": "üéÆ Gaming",
                "description": "Mini-jeux, tournois, achievements",
                "color": "#00ff00",
                "premium": true
            },
            
            // === COMMUNICATION ===
            "voice": {
                "name": "üé§ Vocal",
                "description": "Connexions/d√©connexions vocales",
                "color": "#1abc9c",
                "premium": false
            },
            "messages": {
                "name": "üí¨ Messages",
                "description": "Messages supprim√©s/modifi√©s",
                "color": "#95a5a6",
                "premium": true
            },
            "events": {
                "name": "üéâ √âv√©nements",
                "description": "√âv√©nements serveur programm√©s",
                "color": "#ff69b4",
                "premium": false
            },
            
            // === FONCTIONNALIT√âS AVANC√âES ===
            "suggestions": {
                "name": "üí° Suggestions",
                "description": "Nouvelles suggestions, votes",
                "color": "#ffaa00",
                "premium": false
            },
            "custom_commands": {
                "name": "üîß Commandes personnalis√©es",
                "description": "Utilisation commandes custom",
                "color": "#8e44ad",
                "premium": true
            },
            "threads": {
                "name": "üßµ Fils",
                "description": "Cr√©ation/gestion des threads",
                "color": "#34495e",
                "premium": false
            },
            
            // === PREMIUM EXCLUSIF ===
            "boosters": {
                "name": "‚≠ê Boosters",
                "description": "Boosts serveur, nitro",
                "color": "#ff73fa",
                "premium": true
            },
            "ai_moderation": {
                "name": "üß† IA Mod√©ration",
                "description": "Mod√©ration par intelligence artificielle",
                "color": "#00ffff",
                "premium": true
            },
            "analytics": {
                "name": "üìà Analytics",
                "description": "Statistiques avanc√©es serveur",
                "color": "#2ecc71",
                "premium": true
            }
        };
        
        // Charger la configuration au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            loadConfiguration();
            generateModulesHTML();
        });
        
        function generateModulesHTML() {
            const container = document.getElementById('modules-container');
            
            for (const [moduleKey, moduleInfo] of Object.entries(logModules)) {
                const moduleCard = document.createElement('div');
                moduleCard.className = 'module-card';
                moduleCard.innerHTML = `
                    <div class="module-header">
                        <div class="module-name">
                            <span class="status-indicator status-disabled" id="status-${moduleKey}"></span>
                            ${moduleInfo.name}
                            ${moduleInfo.premium ? '<span class="premium-badge">PREMIUM</span>' : ''}
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle-${moduleKey}" onchange="toggleModule('${moduleKey}')">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="description">${moduleInfo.description}</div>
                    <div class="channel-select">
                        <select id="channel-${moduleKey}" class="form-control" disabled>
                            <option value="">S√©lectionner un salon...</option>
                            <!-- Salons charg√©s dynamiquement -->
                        </select>
                    </div>
                `;
                container.appendChild(moduleCard);
            }
        }
        
        function toggleModule(moduleKey) {
            const toggle = document.getElementById(`toggle-${moduleKey}`);
            const channelSelect = document.getElementById(`channel-${moduleKey}`);
            const statusIndicator = document.getElementById(`status-${moduleKey}`);
            
            channelSelect.disabled = !toggle.checked;
            statusIndicator.className = toggle.checked ? 
                'status-indicator status-enabled' : 'status-indicator status-disabled';
        }
        
        async function loadConfiguration() {
            try {
                const response = await fetch(`/api/logs/config/{{ guild_id }}`);
                const data = await response.json();
                
                if (data.success) {
                    // Charger la configuration dans l'interface
                    console.log('Configuration charg√©e:', data.data);
                }
            } catch (error) {
                console.error('Erreur lors du chargement:', error);
            }
        }
        
        async function saveConfiguration() {
            const config = {
                settings: {
                    default_channel: document.getElementById('default-channel').value,
                    default_color: document.getElementById('default-color').value
                },
                modules: {}
            };
            
            // R√©cup√©rer la configuration de chaque module
            for (const moduleKey of Object.keys(logModules)) {
                const enabled = document.getElementById(`toggle-${moduleKey}`).checked;
                const channelId = document.getElementById(`channel-${moduleKey}`).value;
                
                config.modules[moduleKey] = {
                    enabled: enabled,
                    channel_id: channelId || null
                };
            }
            
            try {
                const response = await fetch(`/api/logs/config/{{ guild_id }}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Configuration sauvegard√©e avec succ√®s !');
                } else {
                    alert('‚ùå Erreur: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Erreur lors de la sauvegarde: ' + error.message);
            }
        }
    </script>
</body>
</html>
'''
